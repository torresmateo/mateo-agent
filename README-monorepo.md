# Using Claude Sessions with Monorepos

The session manager creates a `.env.claude-session` file at your repo root with session-specific environment variables. This file is auto-generated and gitignored, making it perfect for monorepos.

## What's in `.env.claude-session`?

After starting a session, this file contains:
```bash
DATABASE_URL=postgresql://postgres:postgres@claude-session-meg-8-db:5432/appdb
CLAUDE_SESSION_NAME=claude-session-meg-8
CLAUDE_DB_ENABLED=true
```

**Note:** All sessions use the same credentials (`postgres:postgres`) since each session has its own isolated database container. The only difference is the hostname (`claude-session-{SESSION_NAME}-db`).

## Usage Patterns

### Pattern 1: Source in Component .env Files

**Monorepo structure:**
```
my-monorepo/
├── .env.claude-session          # Auto-generated by session manager
├── .gitignore                    # Contains .env.claude-session
├── app/
│   └── server/
│       ├── .env                  # Your component-specific config
│       └── index.js
└── packages/
    └── api/
        ├── .env
        └── index.ts
```

**In `app/server/.env`:**
```bash
# Load session variables
source ../.env.claude-session

# Component-specific overrides (optional)
PORT=3000
NODE_ENV=development
```

**In `packages/api/.env`:**
```bash
# Load session variables
source ../../.env.claude-session

# API-specific config
API_PORT=8080
```

### Pattern 2: Load in Node.js/TypeScript

**Using dotenv:**
```typescript
// app/server/index.ts
import dotenv from 'dotenv';
import path from 'path';

// Load session variables first
dotenv.config({ path: path.join(__dirname, '../../.env.claude-session') });

// Then load component-specific variables (won't override)
dotenv.config({ path: path.join(__dirname, '.env') });

console.log(process.env.DATABASE_URL); // From .env.claude-session
console.log(process.env.PORT);         // From .env
```

**Using dotenv-flow (recommended for monorepos):**
```typescript
// app/server/index.ts
import { config } from 'dotenv-flow';

config({
  path: path.join(__dirname, '../..'),  // Repo root
  files: [
    '.env.claude-session',
    '.env',
    `.env.${process.env.NODE_ENV}`
  ]
});
```

### Pattern 3: Symlink (Simplest)

```bash
# In app/server/
ln -s ../../.env.claude-session .env.session

# Then in your .env:
source .env.session
PORT=3000
```

### Pattern 4: Docker Compose

**In `docker-compose.yml` at repo root:**
```yaml
services:
  server:
    build: ./app/server
    env_file:
      - .env.claude-session  # Session variables
      - app/server/.env      # Component variables
    ports:
      - "3000:3000"
```

### Pattern 5: Package Scripts

**In `app/server/package.json`:**
```json
{
  "scripts": {
    "dev": "dotenv -e ../../.env.claude-session -e .env -- tsx watch src/index.ts",
    "start": "dotenv -e ../../.env.claude-session -e .env -- node dist/index.js"
  }
}
```

## Turbo Monorepo Example

**Repo structure:**
```
my-turbo-repo/
├── .env.claude-session          # Auto-generated
├── turbo.json
├── apps/
│   ├── web/
│   │   ├── .env
│   │   └── next.config.js
│   └── api/
│       ├── .env
│       └── index.ts
└── packages/
    └── database/
        ├── .env
        └── index.ts
```

**In `apps/api/.env`:**
```bash
# Load session DB
source ../../.env.claude-session

# API config
PORT=4000
```

**In `packages/database/.env`:**
```bash
# Load session DB
source ../../.env.claude-session

# No overrides needed - just use DATABASE_URL
```

**In `apps/web/next.config.js`:**
```javascript
require('dotenv').config({ path: '../../.env.claude-session' });

module.exports = {
  env: {
    DATABASE_URL: process.env.DATABASE_URL,
  },
};
```

## Disable Database for Non-DB Projects

```bash
# Frontend-only projects don't need a database
CLAUDE_DB_ENABLED=false ./claude-session.sh start my-frontend-app

# .env.claude-session will contain:
# CLAUDE_SESSION_NAME=claude-session-my-frontend-app
# CLAUDE_DB_ENABLED=false
# (no DATABASE_URL)
```

## Best Practices

1. **Never commit `.env.claude-session`** - It's auto-added to `.gitignore`
2. **Keep component secrets in component `.env` files** - Only load `.env.claude-session` for session-specific variables
3. **Use `.env.example` in each component** - Document what variables are needed
4. **Load order matters**: Session variables first, then component overrides

## Example: Full Stack Monorepo

**Root `.env.claude-session` (auto-generated):**
```bash
DATABASE_URL=postgresql://postgres:postgres@claude-session-meg-8-db:5432/appdb
CLAUDE_SESSION_NAME=claude-session-meg-8
CLAUDE_DB_ENABLED=true
```

**`apps/api/.env`:**
```bash
source ../../.env.claude-session
PORT=4000
JWT_SECRET=your-jwt-secret
```

**`apps/web/.env`:**
```bash
# Frontend doesn't need direct DB access
NEXT_PUBLIC_API_URL=http://localhost:4000
```

**`packages/database/.env`:**
```bash
source ../../.env.claude-session
# DATABASE_URL is now available
```

Now each component gets exactly what it needs!
